<?php
/*
 本代码由 宗师堂 创建
 创建时间 2019-04-09 11:02:42
 技术支持 宗师堂
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Http\Controllers\Api\V1;use App\Http\Controllers\BaseController;use App\Models\Apply;use App\Models\Article;use App\Models\ArticleCollection;use App\Models\ArticlePraise;use App\Models\ArticleShare;use App\Models\Channel;use App\Models\Credit;use App\Models\CreditCollection;use App\Models\CreditShare;use App\Models\Member;use App\Models\Product;use App\Models\ProductCollection;use App\Models\ProductShare;use Illuminate\Http\Request;use App\Http\Controllers\Controller;use Illuminate\Support\Facades\Validator;class ActionController extends BaseController{public function apply(Request $request){$validate=Validator::make($request->all(),['platform'=>'required','type'=>'required','apply_id'=>'required','channel'=>'required',]);$J1f0=!$validate->fails();if($J1f0)goto J1fBodyx2;goto J1fNextx2;J1fBodyx2:$member=Member::where('id',$request->uid)->first();if($member)goto J1fBodyx4;goto J1fNextx4;J1fBodyx4:$J1f0=$request->type=='product';if($J1f0)goto J1fBodyx6;goto J1fNextx6;J1fBodyx6:$product_id=$request->apply_id;$credit_id=0;$field='product_id';goto J1fx5;J1fNextx6:$product_id=0;$credit_id=$request->apply_id;$field='credit_id';J1fx5:$exists=Apply::where(['mid'=>$request->uid,$field=>$request->apply_id])->whereBetween('created_at',[date('Y-m-d 00:00:00'),date('Y-m-d 23:59:59')])->first();$apply=Apply::where(['mid'=>$request->uid,'type'=>'product'])->whereBetween('created_at',[date('Y-m-d 00:00:00'),date('Y-m-d 23:59:59')])->get();$channel=Channel::where('channel_code',$request->channel)->first();$recognition_url='';if($channel)goto J1fBodyx8;goto J1fNextx8;J1fBodyx8:$channel_id=$channel->id;$redirect=$channel->redirect_status;$J1f0=$redirect==0;$J1f2=(bool)$J1f0;if($J1f2)goto J1fBodyxb;goto J1fNextxb;J1fBodyxb:$J1f1=$request->platform=='android';$J1f2=(bool)$J1f1;goto J1fxa;J1fNextxb:J1fxa:if($J1f2)goto J1fBodyxc;goto J1fNextxc;J1fBodyxc:$recognition_url='http://daiwap.kuanjiedai.com/authentication.html';goto J1fx9;J1fNextxc:J1fx9:goto J1fx7;J1fNextx8:$channel_id=0;$redirect=1;J1fx7:if($exists)goto J1fBodyxe;goto J1fNextxe;J1fBodyxe:$this->set('info','success');$apply_num=$apply->count();goto J1fxd;J1fNextxe:Apply::create(['mid'=>$request->uid,'platform'=>$request->platform,'type'=>$request->type,'product_id'=>$product_id,'credit_id'=>$credit_id,'channel_id'=>$channel_id,'channel_code'=>$request->channel,'register_page_id'=>$member->page_id,]);Member::where('id',$request->uid)->update(['last_apply_at'=>date('Y-m-d H:i:s'),]);if($product_id)goto J1fBodyxg;goto J1fNextxg;J1fBodyxg:$product=Product::where('id',$product_id)->first();if($product)goto J1fBodyxi;goto J1fNextxi;J1fBodyxi:$J1f0=$product->control_volume=='yes';if($J1f0)goto J1fBodyxk;goto J1fNextxk;J1fBodyxk:$auto_up_date=date('Y-m-d H:i:00',strtotime($product->auto_up_date)-86400);$apply_product=Apply::where(['type'=>'product','product_id'=>$product_id])->where('created_at','>=',$auto_up_date)->count();$J1f0=$apply_product>=$product->auto_down_sale_num;$J1f2=(bool)$J1f0;if($J1f2)goto J1fBodyxn;goto J1fNextxn;J1fBodyxn:$J1f1=$product->auto_down_sale_num!=0;$J1f2=(bool)$J1f1;goto J1fxm;J1fNextxn:J1fxm:if($J1f2)goto J1fBodyxo;goto J1fNextxo;J1fBodyxo:$product->status=0;$product->save();goto J1fxl;J1fNextxo:J1fxl:goto J1fxj;J1fNextxk:$apply_product=Apply::where(['type'=>'product','product_id'=>$product_id])->count();$J1f0=$apply_product>=$product->auto_down_sale_num;$J1f2=(bool)$J1f0;if($J1f2)goto J1fBodyxr;goto J1fNextxr;J1fBodyxr:$J1f1=$product->auto_down_sale_num!=0;$J1f2=(bool)$J1f1;goto J1fxq;J1fNextxr:J1fxq:if($J1f2)goto J1fBodyxs;goto J1fNextxs;J1fBodyxs:$product->status=0;$product->save();goto J1fxp;J1fNextxs:J1fxp:J1fxj:goto J1fxh;J1fNextxi:J1fxh:goto J1fxf;J1fNextxg:J1fxf:$J1f0=$request->type=='product';if($J1f0)goto J1fBodyxu;goto J1fNextxu;J1fBodyxu:$J1f0=$apply->count()+1;$apply_num=$J1f0;goto J1fxt;J1fNextxu:$apply_num=$apply->count();J1fxt:J1fxd:$J1fAC0=array();$J1fAC0['apply_num']=$apply_num;$J1fAC0['redirect']=$redirect;$J1fAC0['recognition_url']=$recognition_url;$data=$J1fAC0;$this->set('data',$data);goto J1fx3;J1fNextx4:$this->set('type',$this->overdueUser);$this->set('info','请登录');J1fx3:goto J1fx1;J1fNextx2:if($validate->errors()->has('platform'))goto J1fBodyxw;goto J1fNextxw;J1fBodyxw:$this->set('type',$this->badRequest);$this->set('info','请传入操作平台');goto J1fxv;J1fNextxw:if($validate->errors()->has('type'))goto J1fBodyxx;goto J1fNextxx;J1fBodyxx:$this->set('type',$this->badRequest);$this->set('info','请传入操作类型');goto J1fxv;J1fNextxx:if($validate->errors()->has('apply_id'))goto J1fBodyxy;goto J1fNextxy;J1fBodyxy:$this->set('type',$this->badRequest);$this->set('info','请传入申请id');goto J1fxv;J1fNextxy:$this->set('type',$this->badRequest);$this->set('info','请传入操作渠道');J1fxv:J1fx1:return $this->jsonResponse();}public function praise(Request $request,$id){$member=Member::where('id',$request->uid)->first();if($member)goto J1fBodyx11;goto J1fNextx11;J1fBodyx11:$exists=ArticlePraise::where(['mid'=>$request->uid,'article_id'=>$id])->first();if($exists)goto J1fBodyx13;goto J1fNextx13;J1fBodyx13:ArticlePraise::find($exists->id)->delete();$article=Article::where('id',$id)->first();$article->praise=$article->praise-1;$article->save();goto J1fx12;J1fNextx13:if(Article::find($id))goto J1fBodyx15;goto J1fNextx15;J1fBodyx15:ArticlePraise::create(['mid'=>$request->uid,'article_id'=>$id,]);$article=Article::where('id',$id)->first();$article->praise=$article->praise+1;$article->save();goto J1fx14;J1fNextx15:$this->set('type',$this->noContent);$this->set('info','无此资讯信息');J1fx14:J1fx12:$article=Article::where('id',$id)->first();if($article)goto J1fBodyx17;goto J1fNextx17;J1fBodyx17:$praise=$article->praise;goto J1fx16;J1fNextx17:$praise=0;J1fx16:$this->set('data',['praise'=>$praise]);goto J1fxz;J1fNextx11:$this->set('type',$this->overdueUser);$this->set('info','请登录');J1fxz:return $this->jsonResponse();}public function collect(Request $request){$validate=Validator::make($request->all(),['collect_type'=>'required','collect_id'=>'required',]);$J1f0=!$validate->fails();if($J1f0)goto J1fBodyx19;goto J1fNextx19;J1fBodyx19:$member=Member::where('id',$request->uid)->first();if($member)goto J1fBodyx1b;goto J1fNextx1b;J1fBodyx1b:$J1f0=$request->collect_type=='article';if($J1f0)goto J1fBodyx1d;goto J1fNextx1d;J1fBodyx1d:$exists=ArticleCollection::where(['mid'=>$request->uid,'article_id'=>$request->collect_id])->first();if($exists)goto J1fBodyx1f;goto J1fNextx1f;J1fBodyx1f:ArticleCollection::find($exists->id)->delete();goto J1fx1e;J1fNextx1f:if(Article::find($request->collect_id))goto J1fBodyx1h;goto J1fNextx1h;J1fBodyx1h:ArticleCollection::create(['mid'=>$request->uid,'article_id'=>$request->collect_id]);goto J1fx1g;J1fNextx1h:$this->set('type',$this->noContent);$this->set('info','无此资讯信息');J1fx1g:J1fx1e:goto J1fx1c;J1fNextx1d:$J1f0=$request->collect_type=='product';if($J1f0)goto J1fBodyx1i;goto J1fNextx1i;J1fBodyx1i:$exists=ProductCollection::where(['mid'=>$request->uid,'product_id'=>$request->collect_id])->first();if($exists)goto J1fBodyx1k;goto J1fNextx1k;J1fBodyx1k:ProductCollection::find($exists->id)->delete();goto J1fx1j;J1fNextx1k:if(Product::find($request->collect_id))goto J1fBodyx1m;goto J1fNextx1m;J1fBodyx1m:ProductCollection::create(['mid'=>$request->uid,'product_id'=>$request->collect_id]);goto J1fx1l;J1fNextx1m:$this->set('type',$this->noContent);$this->set('info','无此贷款信息');J1fx1l:J1fx1j:goto J1fx1c;J1fNextx1i:J1fx1c:goto J1fx1a;J1fNextx1b:$this->set('type',$this->overdueUser);$this->set('info','请登录');J1fx1a:goto J1fx18;J1fNextx19:if($validate->errors()->has('collect_type'))goto J1fBodyx1o;goto J1fNextx1o;J1fBodyx1o:$this->set('type',$this->badRequest);$this->set('info','请传入收藏类型');goto J1fx1n;J1fNextx1o:$this->set('type',$this->badRequest);$this->set('info','请传入收藏id');J1fx1n:J1fx18:return $this->jsonResponse();}public function share(Request $request){$validate=Validator::make($request->all(),['share_type'=>'required','share_id'=>'required','link'=>'required',]);$J1f0=!$validate->fails();if($J1f0)goto J1fBodyx1q;goto J1fNextx1q;J1fBodyx1q:$member=Member::where('id',$request->uid)->first();if($member)goto J1fBodyx1s;goto J1fNextx1s;J1fBodyx1s:$J1f0=$request->share_type=='article';if($J1f0)goto J1fBodyx1u;goto J1fNextx1u;J1fBodyx1u:$exists=ArticleShare::where(['mid'=>$request->uid,'article_id'=>$request->share_id])->first();if($exists)goto J1fBodyx1w;goto J1fNextx1w;J1fBodyx1w:ArticleShare::find($exists->id)->delete();goto J1fx1v;J1fNextx1w:if(Article::find($request->share_id))goto J1fBodyx1y;goto J1fNextx1y;J1fBodyx1y:ArticleShare::create(['mid'=>$request->uid,'article_id'=>$request->share_id,'link'=>$request->link]);goto J1fx1x;J1fNextx1y:$this->set('type',$this->noContent);$this->set('info','无此资讯信息');J1fx1x:J1fx1v:goto J1fx1t;J1fNextx1u:$J1f0=$request->share_type=='product';if($J1f0)goto J1fBodyx2z;goto J1fNextx2z;J1fBodyx2z:$exists=ProductShare::where(['mid'=>$request->uid,'product_id'=>$request->share_id])->first();if($exists)goto J1fBodyx22;goto J1fNextx22;J1fBodyx22:ProductShare::find($exists->id)->delete();goto J1fx21;J1fNextx22:if(Product::find($request->share_id))goto J1fBodyx24;goto J1fNextx24;J1fBodyx24:ProductShare::create(['mid'=>$request->uid,'product_id'=>$request->share_id,'link'=>$request->link]);goto J1fx23;J1fNextx24:$this->set('type',$this->noContent);$this->set('info','无此贷款信息');J1fx23:J1fx21:goto J1fx1t;J1fNextx2z:J1fx1t:goto J1fx1r;J1fNextx1s:$this->set('type',$this->overdueUser);$this->set('info','请登录');J1fx1r:goto J1fx1p;J1fNextx1q:if($validate->errors()->has('share_type'))goto J1fBodyx26;goto J1fNextx26;J1fBodyx26:$this->set('type',$this->badRequest);$this->set('info','请传入分享类型');goto J1fx25;J1fNextx26:if($validate->errors()->has('share_id'))goto J1fBodyx27;goto J1fNextx27;J1fBodyx27:$this->set('type',$this->badRequest);$this->set('info','请传入分享id');goto J1fx25;J1fNextx27:$this->set('type',$this->badRequest);$this->set('info','请传入分享链接');J1fx25:J1fx1p:return $this->jsonResponse();}}
?>