<?php
/*
 本代码由 宗师堂 创建
 创建时间 2019-04-09 11:02:42
 技术支持 宗师堂
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Http\Controllers\Admin;use App\Models\Channel;use App\Models\Deduction;use App\Models\DeductionApply;use App\Models\DeductionRegister;use App\Models\Member;use App\Models\User;use App\Models\UserModel;use App\Traits\CustomExcel;use Illuminate\Http\Request;use App\Http\Controllers\Controller;use Illuminate\Support\Facades\DB;class MemberController extends Controller{use CustomExcel;public function index(){$user_models=UserModel::all();$channels=Channel::all();return view('admin.member.index',compact('user_models','channels'));}public function data(Request $request,Member $member){$J1f0=$request->get('end_time')<$request->get('start_time');if($J1f0)goto J1fBodyx2;goto J1fNextx2;J1fBodyx2:$J1fAC0=array();$J1fAC0['code']=1;$J1fAC0['msg']='结束时间不能小于开始时间';$J1fAC0['count']='';$J1fAC0['data']='';$data=$J1fAC0;return response()->json($data);goto J1fx1;J1fNextx2:J1fx1:$res=$this->_query_box($request,$member);$J1fAC0=array();$J1fAC0['code']=0;$J1fAC0['msg']='正在请求中...';$J1fAC0['count']=$res['total'];$J1fAC0['data']=$res['data'];$data=$J1fAC0;return response()->json($data);}public function toExcelOld(Request $request,Member $member){set_time_limit(0);$A_____="ini_set";$J1fAC0=$A_____("memory_limit","1024M");$J1f0=$request->get('end_time')<$request->get('start_time');if($J1f0)goto J1fBodyx4;goto J1fNextx4;J1fBodyx4:$J1fAC0=array();$J1fAC0['code']=1;$J1fAC0['msg']='结束时间不能小于开始时间';$J1fAC0['count']='';$J1fAC0['data']='';$data=$J1fAC0;return response()->json($data);goto J1fx3;J1fNextx4:J1fx3:$res=$this->_query_box($request,$member,'excel');if($res)goto J1fBodyx6;goto J1fNextx6;J1fBodyx6:$J1fAC0=array();$result=$J1fAC0;$J1fAC0=array();$J1fAC0[]='用户电话';$J1fAC0[]='渠道名称';$J1fAC0[]='来源平台';$J1fAC0[]='分发页';$J1fAC0[]='渠道所属部门';$J1fAC0[]='渠道负责人';$J1fAC0[]='注册时间';$J1fAC0[]='最后登录时间';$J1fAC0[]='最后申请时间';$J1fAC0[]='IP';$result[]=$J1fAC0;$J1f0=$J1fAC0;foreach($res as $item){$J1fAC0=array();$arr=$J1fAC0;$arr[]=$item['phone'];$J1f0=$item['phone'];$J1f0=$item['channel']['channel_name']??'';$arr[]=$J1f0;$J1f1=$J1f0;$arr[]=$item['platform_register'];$J1f0=$item['platform_register'];$J1f0=$item['page']['name']??'';$arr[]=$J1f0;$J1f1=$J1f0;$J1f0=$item['channel']['department']['name']??'';$arr[]=$J1f0;$J1f1=$J1f0;$J1f0=$item['channel']['manager']??'';$arr[]=$J1f0;$J1f1=$J1f0;$arr[]=$item['created_at'];$J1f0=$item['created_at'];$arr[]=$item['last_login_at'];$J1f0=$item['last_login_at'];$arr[]=$item['last_apply_at'];$J1f0=$item['last_apply_at'];$arr[]=$item['register_ip'];$J1f0=$item['register_ip'];$result[]=$arr;$J1f0=$arr;}$A____A="date";$J1fAC0=$A____A('YmdHis');$J1f0='用户信息' . $J1fAC0;$title=$J1f0;$this->excelExport($title,$result);die();goto J1fx5;J1fNextx6:J1fx5:}public function toExcel(Request $request,Member $member){set_time_limit(0);$A___A_="ini_set";$J1fAC0=$A___A_("memory_limit","1024M");$J1fAC0=array();$J1fAC0['用户电话']='string';$J1fAC0['渠道名称']='string';$J1fAC0['来源平台']='string';$J1fAC0['分发页']='string';$J1fAC0['渠道所属部门']='string';$J1fAC0['渠道负责人']='string';$J1fAC0['注册时间']='string';$J1fAC0['最后登录时间']='string';$J1fAC0['最后申请时间']='string';$J1fAC0['IP']='string';$header=$J1fAC0;$data=$this->_query_box($request,$member,'excel');$J1fAC0=array();$last_data=$J1fAC0;foreach($data as $k=>$datum){$last_data[$k]['phone']=$datum['phone'];$J1f0=$datum['channel']['channel_name']??'';$last_data[$k]['channel_name']=$J1f0;$last_data[$k]['platform_register']=$datum['platform_register'];$J1f0=$datum['page']['name']??'';$last_data[$k]['page_name']=$J1f0;$J1f0=$datum['channel']['department']['name']??'';$last_data[$k]['department']=$J1f0;$J1f0=$datum['channel']['manager']??'';$last_data[$k]['manager']=$J1f0;$A___AA="date";$J1fAC0=$A___AA('Y-m-d H:i:s',strtotime($datum['created_at']));$last_data[$k]['created_at']=$J1fAC0;$A__A__="date";$J1fAC0=$A__A__('Y-m-d H:i:s',strtotime($datum['last_login_at']));$last_data[$k]['last_login_at']=$J1fAC0;if($datum['last_apply_at'])goto J1fBodyx8;goto J1fNextx8;J1fBodyx8:$A__A_A="date";$J1fAC0=$A__A_A('Y-m-d H:i:s',strtotime($datum['last_apply_at']));$J1f0=$J1fAC0;goto J1fx7;J1fNextx8:$J1f0='';J1fx7:$last_data[$k]['last_apply_at']=$J1f0;$last_data[$k]['register_ip']=$datum['register_ip'];}$A__AA_="file_exists";$J1fAC0=$A__AA_(storage_path('app/public/excel'));$J1f0=!$J1fAC0;if($J1f0)goto J1fBodyxa;goto J1fNextxa;J1fBodyxa:$A__AAA="mkdir";$J1fAC0=$A__AAA(storage_path('app/public/excel'));goto J1fx9;J1fNextxa:J1fx9:$J1f0=storage_path('app/public/excel/') . 'test.xlsx';$file_name=$J1f0;$J1f0=new \XLSXWriter();$writer=$J1f0;$writer->writeSheetHeader('Sheet1',$header);foreach($last_data as $row){$writer->writeSheetRow('Sheet1',$row);}$writer->writeToFile($file_name);download('test.xlsx','用户信息.xlsx');}public function _query_box($request,$model,$type='index'){$user=User::find(auth()->user()->id);$phone=$request->phone;$model=$model->query();if($request->get('start_time'))goto J1fBodyxc;goto J1fNextxc;J1fBodyxc:$model=$model->where('created_at','>',$request->get('start_time'));goto J1fxb;J1fNextxc:J1fxb:if($request->get('end_time'))goto J1fBodyxe;goto J1fNextxe;J1fBodyxe:$model=$model->where('created_at','<=',$request->get('end_time'));goto J1fxd;J1fNextxe:J1fxd:if($request->get('app_id'))goto J1fBodyxg;goto J1fNextxg;J1fBodyxg:$model=$model->where('channel_code',$request->get('app_id'));goto J1fxf;J1fNextxg:J1fxf:if($request->get('platform_register'))goto J1fBodyxi;goto J1fNextxi;J1fBodyxi:$model=$model->where('platform_register',$request->get('platform_register'));goto J1fxh;J1fNextxi:J1fxh:if($request->get('phone'))goto J1fBodyxk;goto J1fNextxk;J1fBodyxk:$model=$model->where('phone','like',"%".$phone."%");goto J1fxj;J1fNextxk:J1fxj:if($request->get('ids'))goto J1fBodyxm;goto J1fNextxm;J1fBodyxm:$model=$model->whereIn('id',explode(',',$request->get('ids')));goto J1fxl;J1fNextxm:J1fxl:if($request->get('user_model_id'))goto J1fBodyxo;goto J1fNextxo;J1fBodyxo:$J1f0=!is_array($request->get('user_model_id'));if($J1f0)goto J1fBodyxq;goto J1fNextxq;J1fBodyxq:$user_model_id[0]=$request->get('user_model_id');$uids=getUidFromUserModelSnapshot($user_model_id);goto J1fxp;J1fNextxq:$uids=getUidFromUserModelSnapshot($request->get('user_model_id'));J1fxp:if($uids)goto J1fBodyxs;goto J1fNextxs;J1fBodyxs:$model=$model->whereIn('id',$uids);goto J1fxr;J1fNextxs:J1fxr:goto J1fxn;J1fNextxo:J1fxn:$J1f0=$type=='index';if($J1f0)goto J1fBodyxu;goto J1fNextxu;J1fBodyxu:$res=$model->orderBy('created_at','desc')->with(['channel'=>function($query){$query->with(['department']);},'page'])->paginate($request->get('limit',30))->toArray();$J1f0=!$user->isRoot();if($J1f0)goto J1fBodyxw;goto J1fNextxw;J1fBodyxw:foreach($res['data']as $k=>$re){$A_A___="substr_replace";$J1fAC0=$A_A___($re['phone'],'****',3,5);$res['data'][$k]['phone']=$J1fAC0;}goto J1fxv;J1fNextxw:J1fxv:return $res;goto J1fxt;J1fNextxu:$J1f0=$type=='excel';if($J1f0)goto J1fBodyxx;goto J1fNextxx;J1fBodyxx:$res=$model->orderBy('created_at','desc')->with(['channel'=>function($query){$query->with(['department']);},'page'])->get();$J1f0=!$user->isRoot();if($J1f0)goto J1fBodyxz;goto J1fNextxz;J1fBodyxz:foreach($res as $k=>$re){$res[$k]->phone=substr_replace($re->phone,'****',3,5);}goto J1fxy;J1fNextxz:J1fxy:return $res;goto J1fxt;J1fNextxx:J1fxt:}public function destroy(Request $request){$ids=$request->get('ids');if(empty($ids))goto J1fBodyx12;goto J1fNextx12;J1fBodyx12:return response()->json(['code'=>1,'msg'=>'请选择删除项']);goto J1fx11;J1fNextx12:J1fx11:DB::beginTransaction();try{foreach(Member::whereIn('id',$ids)->get()as $model){$model->delete();}foreach(Deduction::whereIn('mid',$ids)->get()as $model){$model->delete();}foreach(DeductionApply::whereIn('mid',$ids)->get()as $model){$model->delete();}foreach(DeductionRegister::whereIn('mid',$ids)->get()as $model){$model->delete();}DB::commit();return response()->json(['code'=>0,'msg'=>'删除成功']);}catch(\Exception $exception){DB::rollBack();return redirect()->back()->withErrors(['errors'=>$exception->getMessage()])->withInput($request->all());}}public function edit(Request $request,$id){$member=Member::find($id);return view('admin.member.edit',compact('member'));}public function update(Request $request,$id){$member=Member::find($id);$member->phone=$request->phone;$member->save();return redirect()->route('admin.member')->with('status','修改成功！');}}
?>