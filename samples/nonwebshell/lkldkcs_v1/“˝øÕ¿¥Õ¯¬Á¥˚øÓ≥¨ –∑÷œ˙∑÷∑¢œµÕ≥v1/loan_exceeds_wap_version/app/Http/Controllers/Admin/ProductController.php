<?php
/*
 本代码由 宗师堂 创建
 创建时间 2019-04-09 11:02:42
 技术支持 宗师堂
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Http\Controllers\Admin;use App\Http\Requests\ProductCreateRequest;use App\Http\Requests\ProductUpdateRequest;use App\Models\Apply;use App\Models\Channel;use App\Models\Corner;use App\Models\District;use App\Models\Label;use App\Models\Product;use App\Models\ProductCategory;use App\Models\ProductColumn;use App\Models\ProductControlVolume;use App\Models\ProductLabel;use App\Models\ProductMaterial;use App\Models\ProductPlatform;use Illuminate\Http\Request;use App\Http\Controllers\Controller;use Illuminate\Support\Facades\DB;class ProductController extends Controller{public function index(){$columns=ProductColumn::select('id','name')->get();return view('admin.product.index',compact('columns'));}public function data(Request $request){$res=$this->getData($request,'index');$J1fAC0=array();$J1fAC0['code']=0;$J1fAC0['msg']='正在请求中...';$J1fAC0['count']=$res['total'];$J1fAC0['data']=$res['data'];$data=$J1fAC0;return response()->json($data);}public function getData($request,$type){$pageSize=$request->input('limit',$this->pageSize);$name=$request->input('name','');$column_id=$request->input('column_id','');$deal_type=$request->input('deal_type','');$platform=$request->input('platform','');$status=$request->input('status','');$field=$request->input('field','sort');$order=$request->input('order','desc');$ids=$request->input('ids',[]);$res=Product::with(['platform','column','newLabel']);if($name)goto J1fBodyx2;goto J1fNextx2;J1fBodyx2:$res->where('name','like',"%".$name."%");goto J1fx1;J1fNextx2:J1fx1:if($column_id)goto J1fBodyx4;goto J1fNextx4;J1fBodyx4:$res->whereHas('column',function($query)use($column_id){$query->where('id',$column_id);});goto J1fx3;J1fNextx4:J1fx3:if($deal_type)goto J1fBodyx6;goto J1fNextx6;J1fBodyx6:$res->where('deal_type',$deal_type);goto J1fx5;J1fNextx6:J1fx5:if($platform)goto J1fBodyx8;goto J1fNextx8;J1fBodyx8:$res->whereHas('platform',function($query)use($platform){$query->where('platform',$platform);});goto J1fx7;J1fNextx8:J1fx7:$J1f0=$status!='';if($J1f0)goto J1fBodyxa;goto J1fNextxa;J1fBodyxa:$res->where('status','=',$status);goto J1fx9;J1fNextxa:J1fx9:if($ids)goto J1fBodyxc;goto J1fNextxc;J1fBodyxc:$A_A__A="explode";$J1fAC0=$A_A__A(',',$ids);$ids=$J1fAC0;$res=$res->whereIn('id',$ids);goto J1fxb;J1fNextxc:J1fxb:$res=$res->orderBy($field,$order)->orderBy('id','desc');$J1f0=$type=='excel';if($J1f0)goto J1fBodyxe;goto J1fNextxe;J1fBodyxe:$res=$res->get();goto J1fxd;J1fNextxe:$res=$res->paginate($pageSize)->toArray();J1fxd:return $res;}public function create(){$J1f0=new Product();$product=$J1f0;$corners=Corner::where(['type'=>'product'])->orderBy('sort','desc')->get();$labels=ProductLabel::orderBy('sort','desc')->get();$categories=ProductCategory::orderBy('sort','desc')->get();$columns=ProductColumn::orderBy('sort','desc')->get();$materials=ProductMaterial::orderBy('sort','desc')->get();$new_labels=Label::where(['status'=>1])->orderBy('id','asc')->get();$J1fAC0=array();$product->market_element=$J1fAC0;$J1fAC0=array();$product->guess_like=$J1fAC0;return view('admin.product.create',compact('product','corners','labels','categories','columns','materials','new_labels'));}public function store(ProductCreateRequest $request){$data=$request->except(['_token','_method','label','category','column','platform','material']);$J1f0=!isset($data['status']);if($J1f0)goto J1fBodyxg;goto J1fNextxg;J1fBodyxg:$data['status']=0;goto J1fxf;J1fNextxg:$A_A_A_="date";$J1fAC0=$A_A_A_('Y-m-d H:i:s',time());$data['first_onsale_at']=$J1fAC0;J1fxf:$minute=1;$J1f0=$data['fast_lend_unit']=='hour';if($J1f0)goto J1fBodyxi;goto J1fNextxi;J1fBodyxi:$minute=60;goto J1fxh;J1fNextxi:J1fxh:$J1f0=$data['fast_lend_unit']=='day';if($J1f0)goto J1fBodyxk;goto J1fNextxk;J1fBodyxk:$J1f0=60*24;$minute=$J1f0;goto J1fxj;J1fNextxk:J1fxj:$J1f0=$minute*$data['fast_lend_value'];$data['fast_lend_sort']=$J1f0;if(isset($data['market_element']))goto J1fBodyxm;goto J1fNextxm;J1fBodyxm:$data['market_element']=collect($data['market_element'])->values()->all();goto J1fxl;J1fNextxm:$J1fAC0=array();$data['market_element']=$J1fAC0;J1fxl:if(isset($data['guess_like']))goto J1fBodyxo;goto J1fNextxo;J1fBodyxo:$data['guess_like']=collect($data['guess_like'])->values()->all();goto J1fxn;J1fNextxo:$J1fAC0=array();$data['guess_like']=$J1fAC0;J1fxn:if($data['auto_up_date'])goto J1fBodyxq;goto J1fNextxq;J1fBodyxq:$A_A_AA="date";$J1fAC0=$A_A_AA("Y-m-d H:i:s",strtotime($data['auto_up_date']));$data['auto_up_date']=$J1fAC0;goto J1fxp;J1fNextxq:J1fxp:$J1f0=$data['control_volume']==='no';if($J1f0)goto J1fBodyxs;goto J1fNextxs;J1fBodyxs:unset($data['auto_down_sale_num']);unset($data['auto_up_date']);goto J1fxr;J1fNextxs:$volume['uid']=auth()->user()->id;$volume['type']='loan';$J1f0='新增自动下架数为：' . $data['auto_down_sale_num'];$J1f1=$J1f0 . ',每日上架时间为：';$J1f2=$J1f1 . $data['auto_up_date'];$volume['remark']=$J1f2;J1fxr:DB::beginTransaction();try{$product=Product::create($data);$J1f0=$data['control_volume']==='yes';if($J1f0)goto J1fBodyxv;goto J1fNextxv;J1fBodyxv:$volume['product_id']=$product->id;ProductControlVolume::create($volume);goto J1fxu;J1fNextxv:J1fxu:$product->label()->attach($request->input('label'));$product->category()->attach($request->input('category'));$product->column()->attach($request->input('column'));$product->material()->attach($request->input('material'));$district=$request->input('district_limit');$platforms=$request->input('platform');if($platforms)goto J1fBodyxx;goto J1fNextxx;J1fBodyxx:$J1fAC0=array();$arr=$J1fAC0;foreach($platforms as $platform){$J1fAC0=array();$J1fAC0['product_id']=$product->id;$J1fAC0['platform']=$platform;$arr[]=$J1fAC0;$J1f0=$J1fAC0;}DB::table('product_has_platforms')->insert($arr);goto J1fxw;J1fNextxx:J1fxw:if($district)goto J1fBodyxz;goto J1fNextxz;J1fBodyxz:$A_AA__="explode";$J1fAC0=$A_AA__('-',$district);$district_arr=$J1fAC0;$J1fAC0=array();$district_ids=$J1fAC0;$J1fAC0=array();$J1fAC0[]='北京';$J1fAC0[]='天津';$J1fAC0[]='上海';$J1fAC0[]='重庆';$direct_cities=$J1fAC0;foreach($district_arr as $item){$ids=District::where('name','like',"%".$item."%");$A_AA_A="in_array";$J1fAC0=$A_AA_A($item,$direct_cities);if($J1fAC0)goto J1fBodyx12;goto J1fNextx12;J1fBodyx12:$ids=$ids->where('level','province');goto J1fx11;J1fNextx12:if(str_contains($item,'省'))goto J1fBodyx14;goto J1fNextx14;J1fBodyx14:$ids=$ids->where('level','province');goto J1fx13;J1fNextx14:$ids=$ids->where('level','city');J1fx13:J1fx11:$ids=$ids->pluck('id')->all();$district_ids=array_merge($district_ids,$ids);}if($district_ids)goto J1fBodyx16;goto J1fNextx16;J1fBodyx16:$product->district()->attach($district_ids);goto J1fx15;J1fNextx16:J1fx15:goto J1fxy;J1fNextxz:J1fxy:$product->newLabel()->attach($request->new_label);DB::commit();return response()->json(['code'=>0,'msg'=>'保存成功']);}catch(\Exception $exception){DB::rollBack();return response()->json(['code'=>1,'msg'=>'保存失败:'.$exception->getMessage()]);}}public function show($id){}public function edit($id){$product=Product::with(['label','category','column','material'])->where(['id'=>$id])->firstOrFail();$corners=Corner::where(['type'=>'product'])->orderBy('sort','desc')->get();$labels=ProductLabel::orderBy('sort','desc')->get();$categories=ProductCategory::orderBy('sort','desc')->get();$columns=ProductColumn::orderBy('sort','desc')->get();$materials=ProductMaterial::orderBy('sort','desc')->get();$new_labels=Label::where(['status'=>1])->orderBy('id','asc')->get();if($product->market_element)goto J1fBodyx18;goto J1fNextx18;J1fBodyx18:$J1f0=$product->market_element;goto J1fx17;J1fNextx18:$J1fAC0=array();$J1f0=$J1fAC0;J1fx17:$product->market_element=$J1f0;if($product->guess_like)goto J1fBodyx1a;goto J1fNextx1a;J1fBodyx1a:$J1f0=$product->guess_like;goto J1fx19;J1fNextx1a:$J1fAC0=array();$J1f0=$J1fAC0;J1fx19:$product->guess_like=$J1f0;$J1f0=$product->control_volume=='yes';$J1f1=(bool)$J1f0;if($J1f1)goto J1fBodyx1d;goto J1fNextx1d;J1fBodyx1d:$J1f1=(bool)$product->auto_up_date;goto J1fx1c;J1fNextx1d:J1fx1c:if($J1f1)goto J1fBodyx1e;goto J1fNextx1e;J1fBodyx1e:$product->auto_up_date=date('H:i',strtotime($product->auto_up_date));goto J1fx1b;J1fNextx1e:J1fx1b:return view('admin.product.edit',compact('product','corners','labels','categories','columns','materials','new_labels'));}public function update(ProductUpdateRequest $request,$id){$product=Product::findOrFail($id);$data=$request->except(['_token','_method','label','category','column','platform','material']);if(isset($data['market_element']))goto J1fBodyx1g;goto J1fNextx1g;J1fBodyx1g:$data['market_element']=collect($data['market_element'])->values()->all();goto J1fx1f;J1fNextx1g:$J1fAC0=array();$data['market_element']=$J1fAC0;J1fx1f:if(isset($data['guess_like']))goto J1fBodyx1i;goto J1fNextx1i;J1fBodyx1i:$data['guess_like']=collect($data['guess_like'])->values()->all();goto J1fx1h;J1fNextx1i:$J1fAC0=array();$data['guess_like']=$J1fAC0;J1fx1h:$J1f0=!isset($data['status']);if($J1f0)goto J1fBodyx1k;goto J1fNextx1k;J1fBodyx1k:$data['status']=0;goto J1fx1j;J1fNextx1k:$J1f0=!$product->first_onsale_at;if($J1f0)goto J1fBodyx1m;goto J1fNextx1m;J1fBodyx1m:$A_AAA_="date";$J1fAC0=$A_AAA_('Y-m-d H:i:s',time());$data['first_onsale_at']=$J1fAC0;goto J1fx1l;J1fNextx1m:J1fx1l:J1fx1j:$minute=1;$J1f0=$data['fast_lend_unit']=='hour';if($J1f0)goto J1fBodyx1o;goto J1fNextx1o;J1fBodyx1o:$minute=60;goto J1fx1n;J1fNextx1o:J1fx1n:$J1f0=$data['fast_lend_unit']=='day';if($J1f0)goto J1fBodyx1q;goto J1fNextx1q;J1fBodyx1q:$J1f0=60*24;$minute=$J1f0;goto J1fx1p;J1fNextx1q:J1fx1p:$J1f0=$data['auto_up_date']!='';if($J1f0)goto J1fBodyx1s;goto J1fNextx1s;J1fBodyx1s:$A_AAAA="date";$J1fAC0=$A_AAAA("Y-m-d H:i:s",strtotime($data['auto_up_date']));$data['auto_up_date']=$J1fAC0;goto J1fx1r;J1fNextx1s:J1fx1r:$J1f0=$data['control_volume']==='no';if($J1f0)goto J1fBodyx1u;goto J1fNextx1u;J1fBodyx1u:$data['auto_down_sale_num']=0;unset($data['auto_up_date']);goto J1fx1t;J1fNextx1u:J1fx1t:$J1f0=$minute*$data['fast_lend_value'];$data['fast_lend_sort']=$J1f0;$J1f0=$data['control_volume']==='no';if($J1f0)goto J1fBodyx1w;goto J1fNextx1w;J1fBodyx1w:$volume['uid']=auth()->user()->id;$volume['product_id']=$id;$volume['type']='loan';$volume['remark']='设置为不控量';goto J1fx1v;J1fNextx1w:$volume['uid']=auth()->user()->id;$volume['product_id']=$id;$volume['type']='loan';$J1f0='修改自动下架数为：' . $data['auto_down_sale_num'];$J1f1=$J1f0 . ',每日上架时间为：';$J1f2=$J1f1 . $data['auto_up_date'];$volume['remark']=$J1f2;J1fx1v:DB::beginTransaction();try{$product->label()->sync($request->input('label'));$product->category()->sync($request->input('category'));$product->column()->sync($request->input('column'));$product->material()->sync($request->input('material'));$district=$request->input('district_limit');$platforms=$request->input('platform');ProductPlatform::where(['product_id'=>$product->id])->delete();if($platforms)goto J1fBodyx2z;goto J1fNextx2z;J1fBodyx2z:$J1fAC0=array();$arr=$J1fAC0;foreach($platforms as $platform){$J1fAC0=array();$J1fAC0['product_id']=$product->id;$J1fAC0['platform']=$platform;$arr[]=$J1fAC0;$J1f0=$J1fAC0;}DB::table('product_has_platforms')->insert($arr);goto J1fx1y;J1fNextx2z:J1fx1y:$J1fAC0=array();$district_ids=$J1fAC0;if($district)goto J1fBodyx22;goto J1fNextx22;J1fBodyx22:$AA____="explode";$J1fAC0=$AA____('-',$district);$district_arr=$J1fAC0;$J1fAC0=array();$J1fAC0[]='北京';$J1fAC0[]='天津';$J1fAC0[]='上海';$J1fAC0[]='重庆';$direct_cities=$J1fAC0;foreach($district_arr as $key=>$item){$ids=District::where('name','like',"%".$item."%");$AA___A="in_array";$J1fAC0=$AA___A($item,$direct_cities);if($J1fAC0)goto J1fBodyx24;goto J1fNextx24;J1fBodyx24:$ids=$ids->where('level','province');goto J1fx23;J1fNextx24:if(str_contains($item,'省'))goto J1fBodyx26;goto J1fNextx26;J1fBodyx26:$ids=$ids->where('level','province');goto J1fx25;J1fNextx26:$ids=$ids->where('level','city');J1fx25:J1fx23:$ids=$ids->pluck('id')->all();$district_ids=array_merge($district_ids,$ids);}goto J1fx21;J1fNextx22:J1fx21:$product->district()->sync($district_ids);$product->update($data);ProductControlVolume::create($volume);$product->newLabel()->sync($request->new_label);DB::commit();return response()->json(['code'=>0,'msg'=>'保存成功']);}catch(\Exception $exception){DB::rollBack();return response()->json(['code'=>1,'msg'=>'保存失败:'.$exception->getMessage()]);}}public function destroy(Request $request){$ids=$request->get('ids');$J1f0=!$ids;if($J1f0)goto J1fBodyx28;goto J1fNextx28;J1fBodyx28:return response()->json(['code'=>1,'msg'=>'请选择删除项']);goto J1fx27;J1fNextx28:J1fx27:if(Product::whereIn('id',$ids)->delete())goto J1fBodyx2a;goto J1fNextx2a;J1fBodyx2a:return response()->json(['code'=>0,'msg'=>'删除成功']);goto J1fx29;J1fNextx2a:return response()->json(['code'=>1,'msg'=>'删除失败']);J1fx29:}public function status(Request $request){$id=$request->input('id');$status=$request->input('status');$J1f0=$status=='true';if($J1f0)goto J1fBodyx2c;goto J1fNextx2c;J1fBodyx2c:$J1f1=1;goto J1fx2b;J1fNextx2c:$J1f1=0;J1fx2b:$status=$J1f1;$product=Product::findOrFail($id);$J1f0=$status==0;if($J1f0)goto J1fBodyx2e;goto J1fNextx2e;J1fBodyx2e:$res=$this->verifyStatus('product',$id);$J1f0=$res['code']==1;if($J1f0)goto J1fBodyx2g;goto J1fNextx2g;J1fBodyx2g:return response()->json(['code'=>1,'msg'=>$res['msg']]);goto J1fx2f;J1fNextx2g:J1fx2f:goto J1fx2d;J1fNextx2e:J1fx2d:$product->status=$status;if($product->save())goto J1fBodyx2i;goto J1fNextx2i;J1fBodyx2i:return response()->json(['code'=>0,'msg'=>'操作成功']);goto J1fx2h;J1fNextx2i:return response()->json(['code'=>1,'msg'=>'操作失败']);J1fx2h:}public function excel(Request $request){$res=$this->getData($request,'excel');$data=$res->map(function($item){return[$item->id,$item->name,implode('   ',$item->column()->pluck('name')->all()),$item->deal_type,implode('   ',$item->platform()->pluck('platform')->all()),$item->first_onsale_at,$item->updated_at,$item->status==1?('上架'):'下架',$item->sort];})->toArray();array_unshift($data,['ID','产品名称','所属栏目','合作模式','上线平台','初次上架时间','最后更新时间','状态','排序']);excel_export('贷款产品',$data);}public function verifyAutoDownSaleNum($num,$product_id){$apply_num=Apply::where(['type'=>'product','product_id'=>$product_id])->count();$J1f0=intval($num)<=$apply_num;if($J1f0)goto J1fBodyx2k;goto J1fNextx2k;J1fBodyx2k:return false;goto J1fx2j;J1fNextx2k:return true;J1fx2j:}public function autoUpLoan(){$AA__A_="date";$J1fAC0=$AA__A_('Y-m-d H:i:00',time());$hour_minutes=$J1fAC0;$list=Product::where(['control_volume'=>'yes','status'=>0,'auto_up_date'=>$hour_minutes])->get(['id'])->toArray();$everyday=Product::where(['control_volume'=>'yes','auto_up_date'=>$hour_minutes])->get(['id'])->toArray();if($everyday)goto J1fBodyx2m;goto J1fNextx2m;J1fBodyx2m:$AA__AA="date";$J1fAC0=$AA__AA('Y-m-d H:i:00',strtotime("+1 day"));$tomorrow=$J1fAC0;$everday_ids=array_column($everyday,'id');Product::whereIn('id',$everday_ids)->update(['auto_up_date'=>$tomorrow]);goto J1fx2l;J1fNextx2m:J1fx2l:$J1f0=!$list;if($J1f0)goto J1fBodyx2o;goto J1fNextx2o;J1fBodyx2o:echo 'over';goto J1fx2n;J1fNextx2o:$ids=array_column($list,'id');Product::whereIn('id',$ids)->update(['status'=>1]);echo 'over';J1fx2n:}public function syncProductAndChannel(){$products=Product::select()->get();$channels=Channel::select()->get();foreach($products as $product){$product->newLabel()->sync([1]);}foreach($channels as $channel){$channel->newLabel()->sync([1]);}}}
?>